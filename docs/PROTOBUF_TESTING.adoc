= Protobuf Testing
Nguyen Xuan Hung Anh <anhnxh@fsoft.com.vn>
:toc: left
:homepage: http://trilliumsecure.com
:icons: font
:source-highlighter: pygments

== Simple proto file

You have a Device.kt

[source,kt]
----
data class Device(

    @Id
    @GeneratedValue(generator = "custom-uuid")
    var id: UUID = UUID(0, 0),

    var deviceLocation: DeviceLocation = DeviceLocation(),

    var status: DeviceStatus = DeviceStatus.NEW
)
----

.Showcase of a simple proto file base on Device.kt

[source,proto]
----
syntax = "proto3";

package device.message;

option java_multiple_files = true;
option java_package = "device.message.api.proto";
option java_outer_classname = "DeviceProto";

message DeviceProto {
    string id = 1; // Id
    DeviceLocationProto device_location = 2; // Device location
    StatusProto status = 3; // Status

    enum DeviceLocationProto {
        NEW = 0;
        FIXED = 1;
    }
}

message DeviceLocationProto {
    double latitude = 1; // Latitude
    double longitude = 2; // Longitude
}

message DeviceListProto {
    repeated DeviceProto data = 1;
}
----

For more Scalar Value Types go https://developers.google.com/protocol-buffers/docs/proto3

== Service

.Showcase of a simple service

[source,service]
----
fun initialTestProtobuf() =
        DeviceListProto.newBuilder()
            .addData(
                DeviceProto.newBuilder()
                    .setId("2ac7df4d-b801-11e8-8b8c-e0d55e402654")
                    .setDeviceLocation(
                        DeviceLocationProto.newBuilder()
                            .setLatitude(10.8453786)
                            .setLongitude(106.7780029)
                    )
                    .setStatus(DeviceProto.DeviceLocationProto.NEW)
            )
            .build()

----

== Mapper

Mappers are responsible for mapping from and to different data classes for backend, API, persistence, and so on.
These mappers are usually auto-generated by Mapstruct and often require special configuration thus should be
tested for correctness.

.Showcase of a simple mapper

[source,mapper]
----
@Mapper(
    config = GlobalMapperConfig::class,
    uses = [UuidMapper::class, DeviceMapper.BuilderFactory::class] <1>
)
abstract class DeviceMapper {
    @Mappings(
        Mapping(target = "allFields", ignore = true)
    )
    abstract fun toDeviceBuilder(deviceDto: DeviceDto): DeviceProto.Builder // <2>

    @Mappings(
        Mapping(target = "allFields", ignore = true)
    )
    fun toProto(deviceDto: DeviceDto) = toDeviceBuilder(DeviceDto).build() // <3>

    fun toListProto(deviceList: List<DeviceDto>): DeviceListProto = DeviceListProto.newBuilder()
        .addAllData(deviceList.map(::toProto))
        .build() // <4>
}

----

<1> Define builder factory
<2> Map from Device to proto builder
<3> Map from Device to proto object
<4> Create an instance of the class we want to test with all fields filled out.

== Create instances

And map all the other message in proto file. Each message need a constructor for creates
instances of Protobuf builders. Define nested class BuilderFactory in Mapper class

.Showcase of a simple create instances

[source,instances]
----
@Component
    class BuilderFactory {

        fun toProtoBuilder(): EcuAlertProto.Builder = EcuAlertProto.newBuilder()
    }

----

== Sample data test

[source,test]
----
{
	"data": <1>
    [
    	{
	        "id": "49806b0f-bd56-11e8-9e16-e0d55e402654",
	        "deviceLocation": {
	            "latitude": 10.8453789,
	            "longitude": 10.8453789
	        },
	        "status": "NEW"
    	}
	]
}
----

<1> : Variable you define in proto file
